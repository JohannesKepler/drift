<html style="margin:0; padding:0;">
	<head>
		<link rel="stylesheet" href="style.css" />
	</head>	
	<body>
		<img id="img-ship" src="images/ship-med.png">
		<img id="img-goal" src="images/gem-med.png">
		<img id="img-planet" src="images/planet-med.png">
		<img id="img-rock" src="images/rock-med.png">
		<img id="img-cracked" src="images/planet-cracked-med.png">
		<img id="img-fragment" src="images/fragment-med.png">
		<img id="img-you-died" src="images/you-died-med.png">
		<img id="img-you-win" src="images/you-win-med.png">
		<img id="img-cloud" src="images/cloud.png">
		<div style="text-align: center; margin-top: 10px;">
		<canvas id="canvas" width="1200" height="600"/>
		</div>
	</body>

<script type="text/javascript" src="js/model.js"></script>
<script type="text/javascript" src="js/levels.js"></script>
<script type="text/javascript">

	const PROJECTILE_VELOCITY = 1;
	const ROT_SPEED = 0.003;
	var G = 0.02;

	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");

	var img_ship = document.getElementById('img-ship');
	var img_goal = document.getElementById('img-goal');
	var img_planet = document.getElementById('img-planet');
	var img_cracked = document.getElementById('img-cracked');
	var img_fragment = document.getElementById('img-fragment');
	var img_rock = document.getElementById('img-rock');
	var img_cloud = document.getElementById('img-cloud');
	var img_you_died = document.getElementById('img-you-died');
	var img_you_win = document.getElementById('img-you-win');

	function dist(a,b) {
		return Math.sqrt((b.y-a.y)**2 + (b.x - a.x)**2)
	}

	function drawShip(ship) {
		ctx.save();
		ctx.translate(ship.x, ship.y);
		ctx.rotate(ship.phi);
		ctx.drawImage(img_ship, -(img_ship.width/2),-(img_ship.height/2));
		ctx.restore();
	}

	function drawGoal(goal) {
		ctx.drawImage(img_goal, goal.x-(img_goal.width/2),goal.y-(img_goal.height/2));
	}

	function drawPlanet(planet) {
		switch(planet.type) {
			case 'rock':
				ctx.drawImage(img_rock, planet.x-(img_rock.width/2),planet.y-(img_rock.height/2));
				break;			
			case 'cracked':
				ctx.drawImage(img_cracked, planet.x-(img_cracked.width/2),planet.y-(img_cracked.height/2));
				break;			
			default:
				ctx.drawImage(img_planet, planet.x-(img_planet.width/2),planet.y-(img_planet.height/2));
				break;
		}
	}

	function drawFragment(fragment) {
		ctx.drawImage(img_fragment, fragment.x-(img_fragment.width/2),fragment.y-(img_fragment.height/2));		
	}

	function drawCloud(cloud) {
		ctx.drawImage(img_cloud, cloud.x-(img_cloud.width/2),cloud.y-(img_cloud.height/2));
	}

	function drawProjectile(projectile) {
		ctx.fillStyle = "white";
		ctx.fillRect(projectile.x - projectile.size/2, projectile.y-projectile.size/2, projectile.size, projectile.size);
	}

	function drawText(text, style) {		
  		ctx.font = "48px MrPixel"
		var metrics = ctx.measureText(text);
		ctx.fillText(text, (canvas.width/2)-(metrics.width/2), 300);
	}

	function draw() {
  		// Blank the screen
  		ctx.fillStyle = "black";
		ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);

		drawGoal(model.goal);

		model.planets.forEach(function(planet) {
			drawPlanet(planet);
		})

		model.fragments.forEach(fragment => {
			drawFragment(fragment);
		})

		model.projectiles.forEach(function(projectile) {
			drawProjectile(projectile);
		})

		drawShip(model.ship);

		ctx.fillStyle ='white';

		model.clouds.forEach(function(cloud) {
			drawCloud(cloud);
		})

		model.particles.forEach(particle => {
			ctx.fillRect(particle.x - 3, particle.y-3, 6, 6);

		});
		
		// Draw "YOU DIED" if player dies.
		if(model.state == 'dead') {
			ctx.drawImage(img_you_died, canvas.width/2-img_you_died.width/2, canvas.height/2-img_you_died.height/2)
			return;
		}

		// Draw the checkmark if player wins
		if(model.state == 'win') {
			ctx.drawImage(img_you_win, canvas.width/2-img_you_win.width/2, canvas.height/2-img_you_win.height/2)
			return;
		}

		if(model.title.lifespan > 0) {
			if(model.title.lifespan > 1000) {
				drawText(model.title.text, 'white');
			} else {
				ctx.globalAlpha = model.title.lifespan/1000;
				drawText(model.title.text, 'white');
				ctx.globalAlpha = 1;
			}
		}

	}

	document.addEventListener('keydown', (event) => {
		if(model.state == 'win') {
			if(event.key == 'Enter') {
				model.nextLevel();				
			}
			return;
		}

		switch(event.key) {
			case "ArrowRight":
			case "ArrowUp":
				model.rotateShipRight();
				break;

			case "ArrowLeft":
			case "ArrowDown":
				model.rotateShipLeft();
				break;

			case "Enter":
				model.restart();
				break;

			case " ":
				model.fireGun();
				break;

			case "1":
			case "2":
			case "3":
			case "4":
			case "5":
			case "6":
			case "7":
			case "8":
			case "9":
				model.jumpToLevel(parseInt(event.key)-1);
				break;

		} 
	});

	document.addEventListener('keyup', (event) => {
		model.stopShipRotate();
	});

	function step(ts) {
		model.update(ts);
		draw();
		window.requestAnimationFrame(step);
	}

	window.onload = function() {
		model.loadLevels(levels);
		model.start();
		window.requestAnimationFrame(step);		
	}
</script>
</html>
