<html style="margin:0; padding:0;">
	<head>
		<link rel="stylesheet" href="style.css" />
		<meta property="og:image" content="http://ryansturmer.github.io/drift/images/planet-med.png" />
		<meta property="og:title" content="Drift" />
		<meta property="og:type" content="website" />
		<meta property="og:description" content="A puzzle game about drifting through space" />
	</head>	
	<body>
		<img id="img-ship" src="images/ship-med.png">
		<img id="img-goal" src="images/gem-med.png">
		<img id="img-planet" src="images/planet-med.png">
		<img id="img-rock" src="images/rock-med.png">
		<img id="img-cracked" src="images/planet-cracked-med.png">
		<img id="img-fragment" src="images/fragment-med.png">
		<img id="img-you-died" src="images/you-died-med.png">
		<img id="img-you-win" src="images/you-win-med.png">
		<img id="img-cloud" src="images/cloud.png">
		<img id="img-portal" src="images/portal-med.png">
		<div style="text-align: center; margin-top: 10px;">
		<canvas id="canvas" width="1200" height="600"/>
		</div>
	</body>

<script type="text/javascript" src="js/model.js"></script>
<script type="text/javascript" src="js/levels.js"></script>
<script type="text/javascript" src="js/view.js"></script>

<script type="text/javascript">

	const ROT_SPEED = 0.003;
	const PROJECTILE_VELOCITY = 2;

	var G = 0.02;

	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");


	document.addEventListener('keydown', (event) => {
		event.preventDefault();
		if(model.state == 'win') {
			if(event.key == 'Enter') {
				model.nextLevel();				
			}
			return;
		}

		switch(event.key) {
			case "ArrowRight":
			case "ArrowUp":
				model.rotateShipRight();
				break;

			case "ArrowLeft":
			case "ArrowDown":
				model.rotateShipLeft();
				break;

			case "Enter":
				model.restart();
				break;

			case " ":
				model.fireGun();
				break;
			case "n":
			case "N":
				model.nextLevel();
				break;
			case "p":
			case "P":
				model.prevLevel();
				break;
			case "Tab":
				if(model.state === 'paused') { model.resume(); }
				else { model.pause();}
				break;
			case "1":
			case "2":
			case "3":
			case "4":
			case "5":
			case "6":
			case "7":
			case "8":
			case "9":
				model.jumpToLevel(parseInt(event.key)-1);
				break;

		} 
	});

	var view = new DriftView(canvas);
	view.setModel(model);
	var currentItem = null;
	var currentOffset = null;

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

	document.addEventListener('keyup', (evt) => {
		model.stopShipRotate();
	});

	canvas.addEventListener('mousedown', (evt) => {
		var pos = getMousePos(canvas, evt);
		model.planets.forEach((planet, planet_idx) =>  {
			if(dist(pos, planet) < 32) {
				currentItem = planet;
				currentOffset = {x : planet.x - pos.x, y : planet.y - pos.y};
			}
		});
		
		if(dist(pos, model.ship) < 20) {
			currentItem = model.ship;
			currentOffset = {x : model.ship.x - pos.x, y : model.ship.y - pos.y};
		}
	});

	canvas.addEventListener('mouseup', (evt) => {
		currentItem = null;
		currentOrigin = null;
	});

	canvas.addEventListener('mousemove', (evt) => {
		var pos = getMousePos(canvas, evt);
		if(currentItem) {
			currentItem.x = pos.x + currentOffset.x;
			currentItem.y = pos.y + currentOffset.y;
		}
	});

	function step(ts) {
		model.update(ts);
		view.draw();
		window.requestAnimationFrame(step);
	}

	window.onload = function() {
		model.loadLevels(levels,0);
		model.start();
		window.requestAnimationFrame(step);		
	}

</script>
</html>
